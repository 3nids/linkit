<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Linkit by 3nids</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Linkit</h1>
        <p>Link It offers an easy way to link features on the map from the available relations in the project.</p>
        <p class="view"><a href="https://github.com/3nids/linkit">View the Project on GitHub <small>3nids/linkit</small></a></p>
        <ul>
          <li><a href="https://github.com/3nids/linkit/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/3nids/linkit/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/3nids/linkit">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>
<a name="what-" class="anchor" href="#what-"><span class="octicon octicon-link"></span></a>What ?</h2>

<p>Link It offers an easy way to link features on the map from the available relations in the project.</p>

<h2>
<a name="how-" class="anchor" href="#how-"><span class="octicon octicon-link"></span></a>How ?</h2>

<p>A demo is visible on <a href="http://youtu.be/KhpVAQ0Irqg">youtube</a>.</p>

<ol>
<li>Create relation in the project properties</li>
<li>In the referencing layer properties, set the corresponding field as a "relation reference" widget</li>
<li>Show the dock using the dedicated icon</li>
<li>Select the corresponding relation</li>
<li>Using the provided map tool, choose the referencing feature you want to show/edit.</li>
<li>If editing on the referencing layer is turned on, you can choose a new referenced map tool using the other provided map tool.</li>
</ol><h2>
<a name="tip" class="anchor" href="#tip"><span class="octicon octicon-link"></span></a>Tip</h2>

<p>If you want to have a postgis layer drawing a nice arrow from one feature (child) to another (parent), here you go.
Just change the values between underscores. </p>

<pre><code>CREATE OR REPLACE VIEW _schema_._view_name_ AS
    SELECT child, parent,
         ST_CurveToLine(ST_GeomFromEWKT('SRID=_YOURSRID_;CIRCULARSTRING('
            ||ST_X(start_point)||' '||ST_Y(start_point)
            ||','||
            ST_X(middle_point)+distance*cos(azimuth)||' '||ST_Y(middle_point)+distance*sin(azimuth)
            ||','||
            ST_X(end_point)||' '||ST_Y(end_point) 
            ||')'
        ),15)::geometry(LineString,21781) AS wkb_geometry
    FROM (
        SELECT child,parent,
            start_point , end_point ,
            pi()/2+ST_Azimuth(start_point,end_point) AS azimuth,
            .5*ST_Distance(start_point,end_point) AS distance,
            ST_Line_Interpolate_Point(ST_MakeLine( start_point , end_point ),.5)::geometry(Point,21781) AS middle_point
        FROM (
            SELECT a.id AS child ,b.id AS parent, 
                    ST_Line_Interpolate_Point(a.wkb_geometry,.5)::geometry(Point,21781) AS start_point,
                    /* select end_point at 4 meters from the closest side of the pipe */
                    ST_ClosestPoint(ST_MakeLine(  
                        ST_Line_Interpolate_Point(b.wkb_geometry,   LEAST(1,  4/b._length2d/2))::geometry(Point,21781) ,
                        ST_Line_Interpolate_Point(b.wkb_geometry,GREATEST(0,1-4/b._length2d/2))::geometry(Point,21781) 
                    ),a.wkb_geometry) AS end_point
            FROM _yourschema_._yourtable_ a 
            INNER JOIN _yourschema_._yourtable_ b ON a._fieldOfParentID_ = b.id
            WHERE a.id_parent IS NOT NULL
        ) AS foo
    ) AS foo2;
</code></pre>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/3nids">3nids</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>